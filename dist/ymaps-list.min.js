"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,o){for(var s=0;s<o.length;s++){var i=o[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(o,s,i){return s&&t(o.prototype,s),i&&t(o,i),o}}();function _classCallCheck(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}var Ylist=function(){function t(o){_classCallCheck(this,t),this.options=o,this.map=null,o.hasOwnProperty("data")?this.points=this.options.data:this.points=null,this.placemarks=[],this.activePlacemark=null,this.activeListItem=null,this.clusterer=null,this.balloonLayout=null,this.balloonParams={balloonWidth:null,balloonHeight:null,balloonTailHeight:15},this.listClassName="ylist-list",this.isLessThanAdaptiveBreakpoint=!1,this.mqlAdaptiveBreakpoint=window.matchMedia("(max-width: "+(this.options.adaptiveBreakpoint-1)+"px)"),this.needReloadMap=!0}return _createClass(t,[{key:"init",value:function(){this._checkRequiredOptions();var t=this;ymaps.ready(function(){t.mqlAdaptiveBreakpoint.addListener(function(){t._adaptiveHandle(this,t)}),t._adaptiveHandle(t.mqlAdaptiveBreakpoint,t)}),this.options.list.active&&this._initList()}},{key:"_checkRequiredOptions",value:function(){if(!this.points)throw new Error("You need to JSON data");if(!this.options.hasOwnProperty("dataOrder")||this.options.hasOwnProperty("dataOrder")&&0==this.options.dataOrder.length)throw new Error("You need to set dataOrder option");if(this.options.hasOwnProperty("dataExtension")||(this.options.dataExtension={}),!this.options.hasOwnProperty("container"))throw new Error("You need to set container option");if(this.options.hasOwnProperty("map")||(this.options.map={}),this.options.hasOwnProperty("map")&&"object"==_typeof(this.options.map)){if(!this.options.map.hasOwnProperty("center"))throw new Error("You need to set map.center option");if(!this.options.map.hasOwnProperty("container"))throw new Error("You need to set map.container option");this.options.map.hasOwnProperty("customize")||(this.options.map.customize=!1),this.options.map.hasOwnProperty("customize")&&"object"==_typeof(this.options.map.customize)&&(this.options.map.customize.hasOwnProperty("state")||(this.options.map.customize.state=!1),this.options.map.customize.hasOwnProperty("options")||(this.options.map.customize.options={}),this.options.map.customize.hasOwnProperty("controls")||(this.options.map.customize.controls=!1)),this.options.map.hasOwnProperty("drag")||(this.options.map.drag={}),this.options.map.hasOwnProperty("drag")&&"object"==_typeof(this.options.map.drag)&&(this.options.map.drag.hasOwnProperty("disableBeforeBreakpoint")||(this.options.map.drag.disableBeforeBreakpoint=!0),this.options.map.drag.hasOwnProperty("disableAfterBreakpoint")||(this.options.map.drag.disableAfterBreakpoint=!1)),this.options.map.hasOwnProperty("tooltip")||(this.options.map.tooltip={}),this.options.map.hasOwnProperty("tooltip")&&"object"==_typeof(this.options.map.tooltip)&&(this.options.map.tooltip.hasOwnProperty("active")||(this.options.map.tooltip.active=!0),this.options.map.tooltip.hasOwnProperty("tooltipText")||(this.options.map.tooltip.tooltipText="To drag map touch screen by two fingers and move"))}if(this.options.hasOwnProperty("list")||(this.options.list={}),this.options.hasOwnProperty("list")&&"object"==_typeof(this.options.list)){if(this.options.list.hasOwnProperty("active")||(this.options.list.active=!1),this.options.list.hasOwnProperty("active")&&this.options.list.active&&!this.options.list.hasOwnProperty("container"))throw new Error("You need to set container option in list");this.options.list.hasOwnProperty("scroll")||(this.options.list.scroll=!1),this.options.list.hasOwnProperty("header")||(this.options.list.header=!0),this.options.list.hasOwnProperty("modifier")||(this.options.list.modifier="")}this.options.hasOwnProperty("switchContainer")||(this.options.switchContainer=!1),this.options.hasOwnProperty("cluster")||(this.options.cluster={}),this.options.hasOwnProperty("cluster")&&"object"==_typeof(this.options.cluster)&&(this.options.cluster.hasOwnProperty("icons")||(this.options.cluster.icons=["islands#invertedRedClusterIcons","islands#invertedBlueClusterIcons"]),this.options.cluster.hasOwnProperty("inlineStyle")||(this.options.cluster.inlineStyle="")),this.options.hasOwnProperty("placemark")||(this.options.placemark={}),this.options.hasOwnProperty("placemark")&&"object"==_typeof(this.options.placemark)&&(this.options.placemark.hasOwnProperty("icons")||(this.options.placemark.icons=["islands#redDotIcon","islands#blueDotIcon"]),this.options.placemark.hasOwnProperty("clicked")||(this.options.placemark.clicked=!0)),this.options.hasOwnProperty("balloon")||(this.options.balloon={}),this.options.hasOwnProperty("balloon")&&"object"==_typeof(this.options.balloon)&&(this.options.balloon.hasOwnProperty("activeBeforeBreakpoint")||(this.options.balloon.activeBeforeBreakpoint=!1),this.options.balloon.hasOwnProperty("activeAfterBreakpoint")||(this.options.balloon.activeAfterBreakpoint=!1),this.options.balloon.hasOwnProperty("closeButton")||(this.options.balloon.closeButton="x"),this.options.balloon.hasOwnProperty("header")||(this.options.balloon.header=!0),this.options.balloon.hasOwnProperty("mapOverflow")||(this.options.balloon.mapOverflow=!0),this.options.balloon.hasOwnProperty("modifier")||(this.options.balloon.modifier="")),this.options.hasOwnProperty("adaptiveBreakpoint")||(this.options.adaptiveBreakpoint=1024)}},{key:"_initMap",value:function(){this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null),this.options.map.tooltip.active&&this._initMapTooltip();var t={center:this.options.map.center,zoom:13,controls:[]},o=null;"object"==_typeof(this.options.map.customize)&&"object"==_typeof(this.options.map.customize.state)&&(o=this._setMapState(this.options.map.customize.state,t)),this.map=new ymaps.Map(this.options.map.container,o||t,this.options.map.customize.options),"object"==_typeof(this.options.map.customize)&&"object"==_typeof(this.options.map.customize.controls)&&this._setMapControls(this.options.map.customize.controls),this.map.behaviors.disable("scrollZoom"),this._createPlacemarks(),"boolean"!=typeof this.options.cluster||this.options.cluster?(this._createClusterer(),this._addClusterer(),this._setBounds(this.clusterer)):(this._addPlacemarks(),this._setBounds(this.map.geoObjects)),(this.isLessThanAdaptiveBreakpoint&&this.options.map.drag.disableBeforeBreakpoint||!this.isLessThanAdaptiveBreakpoint&&this.options.map.drag.disableAfterBreakpoint)&&this.map.behaviors.disable("drag"),this.needReloadMap=!1}},{key:"_destroyMap",value:function(){this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null)}},{key:"_initList",value:function(){this._createPointsList()}},{key:"_initMapTooltip",value:function(){var t=$("#"+this.options.map.container),o=$('<div class="ylist-tooltip">\n                              <span class="ylist-tooltip__text">'+this.options.map.tooltip.tooltipText+"</span>\n                          </div>");t.remove(".ylist-tooltip"),t.append(o),t.off("touchmove touchstart touchend touchleave touchcancel"),this.isLessThanAdaptiveBreakpoint&&this.options.map.drag.disableBeforeBreakpoint&&t.on("touchmove",function(t){1==t.originalEvent.touches.length?o.css("opacity","1"):o.css("opacity","0")}).on("touchstart touchend touchleave touchcancel",function(t){o.css("opacity","0")})}},{key:"_setMapState",value:function(t,o){return Object.assign({},o,t)}},{key:"_setMapControls",value:function(t){var o=this;t.forEach(function(t){var s={};if(!t.hasOwnProperty("constructor"))throw new Error("Нужно указать название метода-конструктора. Например:\nhttps://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/control.FullscreenControl-docpage/");s.options=t.options,o.map.controls.add(new ymaps.control[t.constructor](s))})}},{key:"_createPlacemarks",value:function(){for(var t=this,o=0;o<this.points.length;o++){var s=void 0,i=this.options.balloon.activeBeforeBreakpoint,e=this.options.balloon.activeAfterBreakpoint;s=i&&e&&this.options.placemark.clicked||i&&!e&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!i&&e&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked?this._setBalloonData(o):{};var a=this.points[o],n=new ymaps.Placemark(a.coords,s,this._setPlacemarkOptions(o));n.id=a.id,n.events.add("click",function(o){t._commonClickHandler(o.get("target"))}),this.activeListItem&&this.activeListItem==a.id&&("string"==typeof this.options.placemark.icons[0]?n.options.set("preset",this.options.placemark.icons[1]):n.options.set("iconImageHref",this.options.placemark.icons[1].href),n.isActive=!0),this.placemarks.push(n)}}},{key:"_addPlacemarks",value:function(){for(var t=0;t<this.placemarks.length;t++)this.map.geoObjects.add(this.placemarks[t])}},{key:"_setPlacemarkOptions",value:function(t){var o={},s=this.options.balloon.activeBeforeBreakpoint,i=this.options.balloon.activeAfterBreakpoint;return"string"==typeof this.options.placemark.icons[0]?o.preset=this.options.placemark.icons[0]:(o.iconLayout="default#image",o.iconImageHref=this.options.placemark.icons[0].href,o.iconImageSize=this.options.placemark.icons[0].size,o.iconImageOffset=this.options.placemark.icons[0].offset),(s&&i&&this.options.placemark.clicked||s&&!i&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!s&&i&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked)&&(o.balloonLayout=this._createBalloonLayout(),o.balloonContentLayout=this._createBalloonContentLayout(),o.balloonAutoPan=!1,o.balloonShadow=!1,o.balloonPanelMaxMapArea=0),this.options.placemark.clicked||(o.cursor="default"),o}},{key:"_createClusterer",value:function(){if(this.clusterer&&this.clusterer.removeAll(),this.clusterer=new ymaps.Clusterer({groupByCoordinates:!1,clusterDisableClickZoom:!1,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,zoomMargin:40}),"string"==typeof this.options.cluster.icons[0])this.clusterer.options.set({preset:this.options.cluster.icons[0]});else{var t=ymaps.templateLayoutFactory.createClass('<div style="'+this.options.cluster.inlineStyle+'">{{ properties.geoObjects.length }}</div>');this.clusterer.options.set({clusterIcons:this.options.cluster.icons[0],clusterNumbers:[100],clusterIconContentLayout:t})}this.clusterer.add(this.placemarks)}},{key:"_addClusterer",value:function(){this.map.geoObjects.add(this.clusterer)}},{key:"_createBalloonLayout",value:function(){var t=this;return ymaps.templateLayoutFactory.createClass('<div class="ylist-balloon '+this.options.balloon.modifier+'">\n                <button class="ylist-balloon__close" type="button">'+this.options.balloon.closeButton+'</button>\n                <div class="ylist-balloon__inner">\n                    $[[options.contentLayout]]\n                </div>\n            </div>',{build:function(){this.constructor.superclass.build.call(this),this._$element=$(".ylist-balloon",this.getParentElement()),this.applyElementOffset(),this._$element.find(".ylist-balloon__close").on("click",$.proxy(this.onCloseClick,this)),t.balloonParams.balloonWidth=this._$element[0].offsetWidth,t.balloonParams.balloonHeight=this._$element[0].offsetHeight+t.balloonParams.balloonTailHeight},clear:function(){this._$element.find(".ylist-balloon__close").off("click"),this.constructor.superclass.clear.call(this)},onSublayoutSizeChange:function(){this.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments),this._isElement(this._$element)&&(this.applyElementOffset(),this.events.fire("shapechange"))},applyElementOffset:function(){this._$element.css({left:-this._$element[0].offsetWidth/2,top:-(this._$element[0].offsetHeight+t.balloonParams.balloonTailHeight)})},onCloseClick:function(t){t.preventDefault(),this.events.fire("userclose")},_isElement:function(t){return t&&t[0]&&t.find(".ylist-balloon__inner")[0]}})}},{key:"_createBalloonContentLayout",value:function(){var t="";return t=!1===this.options.balloon.header?'<div class="ylist-balloon__content">$[properties.balloonContent]</div>':'<h3 class="ylist-balloon__title">$[properties.balloonHeader]</h3>\n                                    <div class="ylist-balloon__content">$[properties.balloonContent]</div>',ymaps.templateLayoutFactory.createClass(t)}},{key:"_setBalloonData",value:function(t){for(var o="",s="",i=0;i<this.options.dataOrder.length;i++){var e=this.options.dataOrder[i],a="",n="";this.options.dataExtension.hasOwnProperty(e)&&"name"!=e?n=this.options.dataExtension[e](this.points[t][e],this.points[t]):this.options.dataExtension.hasOwnProperty(e)&&"name"==e?a=this.options.dataExtension[e](this.points[t][e],this.points[t]):(a=this.points[t].name,n=this.points[t][e]),o+=a,s+=n}return{balloonHeader:o,balloonContent:s}}},{key:"_setBalloonPane",value:function(t,o,s){s=s||{globalPixelCenter:t.getGlobalPixelCenter(),zoom:t.getZoom()};var i=t.container.getSize(),e=[[s.globalPixelCenter[0]-i[0]/2,s.globalPixelCenter[1]-i[1]/2],[s.globalPixelCenter[0]+i[0]/2,s.globalPixelCenter[1]+i[1]/2]],a=o.balloon.getPosition(),n=Math.pow(2,s.zoom-t.getZoom()),l=ymaps.util.pixelBounds.containsPoint(e,[a[0]*n,a[1]*n]),r="outerBalloon"==o.options.get("balloonPane");!l&&r?o.options.set({balloonPane:"balloon",balloonShadowPane:"shadows"}):l&&!r&&o.options.set({balloonPane:"outerBalloon",balloonShadowPane:"outerBalloon"})}},{key:"_createListElement",value:function(t){var o=$("<h3/>",{class:this.listClassName+"__title"}),s="",i=$("<li/>",{id:t.id,class:this.listClassName+"__item"});t.name&&this.options.list.header?this.options.dataExtension.hasOwnProperty("name")?o.html(this.options.dataExtension.name(t.name,t)):o.html(t.name):o=null;for(var e=0;e<this.options.dataOrder.length;e++){var a=this.options.dataOrder[e],n="";this.options.dataExtension.hasOwnProperty(a)&&"name"!=a?n=this.options.dataExtension[a](t[a],t):"name"!=a&&(n=t[a]),s+=n}return i.append(o,s),i}},{key:"_createPointsList",value:function(){for(var t=this,o=$("<ul/>",{class:this.listClassName+" "+this.options.list.modifier}),s=0;s<this.points.length;s++){var i=this.points[s];o.append(this._createListElement(i))}$("#"+this.options.list.container).html("").append(o),$(document).off("click","."+t.listClassName+"__title"),$(document).on("click","."+t.listClassName+"__title",function(o){var s=$(this).closest("."+t.listClassName+"__item").attr("id");if(t.placemarks.length>0)for(var i=0;i<t.placemarks.length;i++){var e=t.placemarks[i];if(e.id==s){t._listItemClickHandler(o,e);break}}else t._listItemClickHandler(o,s)})}},{key:"_setBounds",value:function(t){"object"===_typeof(this.placemarks)&&1===this.placemarks.length?this.map.setCenter(this.placemarks[0].geometry.getCoordinates(),16):this.map.setBounds(t.getBounds(),{checkZoomRange:!0,zoomMargin:10})}},{key:"_listItemClickHandler",value:function(t,o){if("none"!==$("#"+this.options.map.container).css("display")?o.events.fire("click"):this._commonClickHandler(o),"string"!=typeof o){if(this.activePlacemark&&this.map.getZoom()<11){var s=this.clusterer.getObjectState(this.activePlacemark).isClustered,i=this.clusterer.getObjectState(o).isClustered;if(!s&&!i)return this.map.panTo(o.geometry.getCoordinates(),{flying:!0}),void(this.activePlacemark=o)}for(var e=9===this.map.getZoom()?this.map.getZoom():9;this.map.setCenter(o.geometry.getCoordinates(),e++),this.clusterer.getObjectState(o).isClustered;);this.activePlacemark=o}}},{key:"_commonClickHandler",value:function(t){var o=this,s=null,i=null,e=null,a=this.options.list.active,n=this.options.balloon.activeBeforeBreakpoint,l=this.options.balloon.activeAfterBreakpoint;if(o.options.placemark.clicked){if(a&&(s=$("#"+this.options.list.container)),o.activePlacemark=t,"string"==typeof t)a&&(i=$("#"+t)),e=t;else{a&&(i=$("#"+t.id)),e=t.id;for(var r=0;r<this.placemarks.length;r++){var p=this.placemarks[r];"string"==typeof this.options.placemark.icons[0]?p.options.set("preset",this.options.placemark.icons[0]):p.options.set("iconImageHref",this.options.placemark.icons[0].href),p.balloon.close(),this.clusterer.getObjectState(p).cluster&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(p).cluster.options.set("preset",this.options.cluster.icons[0]):this.clusterer.getObjectState(p).cluster.options.set("clusterIcons",this.options.cluster.icons[0])),p.isActive=!1}this.clusterer.getObjectState(t).isClustered&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(t).cluster.options.set("preset",this.options.cluster.icons[1]):this.clusterer.getObjectState(t).cluster.options.set("clusterIcons",this.options.cluster.icons[1])),"string"==typeof this.options.placemark.icons[0]?t.options.set("preset",this.options.placemark.icons[1]):t.options.set("iconImageHref",this.options.placemark.icons[1].href),t.isActive=!0}if(this.activeListItem=e,a&&(s.find("."+this.listClassName+"__item.is-active").removeClass("is-active"),i.addClass("is-active"),"boolean"!=typeof this.options.list.scroll||this.options.list.scroll?this.options.list.scroll(s,i):s.scrollTop(i.position().top+s.scrollTop())),"none"!==$("#"+this.options.map.container).css("display"))if(n&&l||n&&!l&&this.isLessThanAdaptiveBreakpoint||!n&&l&&!this.isLessThanAdaptiveBreakpoint){if(!1===this.options.balloon.mapOverflow){var c=function(s){"outerBalloon"===t.options.get("balloonPane")&&o._setBalloonPane(o.map,t,s.get("tick"))},h=function(s){"outerBalloon"!==t.options.get("balloonPane")&&o._setBalloonPane(o.map,t,s.get("tick"))};o.map.geoObjects.events.add("balloonopen",function(){o.map.events.add("actiontick",c),o.map.events.add("actiontickcomplete",h),o._setBalloonPane(o.map,t)}),o.map.geoObjects.events.add("balloonclose",function(){o.map.events.remove("actiontick",c),o.map.events.remove("actiontickcomplete",h)})}o.map.geoObjects.events.add("balloonopen",function s(){var i,e=void 0,a=!1===o.options.balloon.mapOverflow?4:2;(e=o.map.options.get("projection").toGlobalPixels(t.geometry.getCoordinates(),o.map.getZoom()))[1]-=o.balloonParams.balloonHeight/a,i=o.map.options.get("projection").fromGlobalPixels(e,o.map.getZoom()),o.map.panTo(i,{flying:!0}),o.map.geoObjects.events.remove("balloonopen",s)})}else o.map.panTo(t.geometry.getCoordinates(),{flying:!0})}}},{key:"_adaptiveHandle",value:function(t,o){var s=o.options.list.active;t.matches?(o.isLessThanAdaptiveBreakpoint=!0,o.needReloadMap=!0,s&&o._destroyMap(),0!=o.options.switchContainer&&($("#"+o.options.switchContainer).addClass("is-visible"),$("#"+o.options.switchContainer).find('[data-ylist-switch="list"]').addClass("is-active")),s&&$("#"+o.options.map.container).addClass("is-hidden"),$("#"+o.options.map.container).addClass("is-adaptive"),$("#"+o.options.list.container).addClass("is-adaptive"),$("#"+o.options.container).addClass("is-adaptive"),s||o.map||o._initMap(),!s&&o.map&&(o.options.map.drag.disableBeforeBreakpoint?o.map.behaviors.disable("drag"):o.map.behaviors.enable("drag"),this.options.map.tooltip.active&&this._initMapTooltip()),$(document).on("click","#"+o.options.switchContainer+" [data-ylist-switch]",function(t){o._switchHandler(t,o)})):(o.isLessThanAdaptiveBreakpoint=!1,0!=o.options.switchContainer&&($("#"+o.options.switchContainer).removeClass("is-visible"),$("#"+o.options.switchContainer).find("[data-ylist-switch]").removeClass("is-active")),$("#"+o.options.map.container).removeClass("is-adaptive is-hidden"),$("#"+o.options.list.container).removeClass("is-adaptive is-hidden"),$("#"+o.options.container).removeClass("is-adaptive"),!s&&(s||o.isLessThanAdaptiveBreakpoint||o.map)||o._initMap(),!s&&o.map&&(o.options.map.drag.disableAfterBreakpoint?o.map.behaviors.disable("drag"):o.map.behaviors.enable("drag"),this.options.map.tooltip.active&&this._initMapTooltip()),$(document).off("click","#"+o.options.switchContainer+" [data-ylist-switch]",o._switchHandler))}},{key:"_switchHandler",value:function(t,o){var s=$(t.target);s.length&&!s.hasClass("is-active")&&("map"===s.attr("data-ylist-switch")?($("#"+o.options.map.container).removeClass("is-hidden"),$("#"+o.options.list.container).addClass("is-hidden"),o.needReloadMap&&o._initMap()):"list"===s.attr("data-ylist-switch")&&($("#"+o.options.map.container).addClass("is-hidden"),$("#"+o.options.list.container).removeClass("is-hidden")),$("#"+o.options.switchContainer+" [data-ylist-switch]").removeClass("is-active"),s.addClass("is-active"))}}]),t}();