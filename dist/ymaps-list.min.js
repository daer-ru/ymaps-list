"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,s){for(var o=0;o<s.length;o++){var i=s[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(s,o,i){return o&&t(s.prototype,o),i&&t(s,i),s}}();function _classCallCheck(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}var Ylist=function(){function t(s){_classCallCheck(this,t),this.options=s,this.map=null,s.hasOwnProperty("data")?this.points=this.options.data:this.points=null,this.placemarks=[],this.activePlacemark=null,this.activeListItem=null,this.clusterer=null,this.balloonLayout=null,this.balloonParams={balloonWidth:null,balloonHeight:null,balloonTailHeight:15},this.listClassName="ylist-list",this.isLessThanAdaptiveBreakpoint=!1,this.mqlAdaptiveBreakpoint=window.matchMedia("(max-width: "+(this.options.adaptiveBreakpoint-1)+"px)"),this.needReloadMap=!0}return _createClass(t,[{key:"init",value:function(){this._checkRequiredOptions();var t=this;ymaps.ready(function(){t.mqlAdaptiveBreakpoint.addListener(function(){t._adaptiveHandle(this,t)}),t._adaptiveHandle(t.mqlAdaptiveBreakpoint,t)}),this.options.list&&this._initList()}},{key:"_checkRequiredOptions",value:function(){this.points?!this.options.hasOwnProperty("dataOrder")||this.options.hasOwnProperty("dataOrder")&&0==this.options.dataOrder.length?console.log("You need to set dataOrder option"):this.options.hasOwnProperty("container")?this.options.hasOwnProperty("mapCenter")?this.options.hasOwnProperty("mapContainer")?(this.options.hasOwnProperty("list")||(this.options.list=!1),this.options.hasOwnProperty("list")&&this.options.list&&!this.options.hasOwnProperty("listContainer")?console.log("You need to set listContainer option"):(this.options.hasOwnProperty("listScroll")||(this.options.listScroll=!1),this.options.hasOwnProperty("listParams")||(this.options.listParams={}),this.options.hasOwnProperty("listParams")&&"object"==_typeof(this.options.listParams)&&(this.options.listParams.hasOwnProperty("showHeader")||(this.options.listParams.showHeader=!0)),this.options.hasOwnProperty("switchContainer")||(this.options.switchContainer=!1),this.options.hasOwnProperty("cluster")||(this.options.cluster={}),this.options.hasOwnProperty("cluster")&&"object"==_typeof(this.options.cluster)&&!this.options.cluster.hasOwnProperty("icons")&&(this.options.cluster.icons=["islands#invertedRedClusterIcons","islands#invertedBlueClusterIcons"]),this.options.hasOwnProperty("cluster")&&"object"==_typeof(this.options.cluster)&&!this.options.cluster.hasOwnProperty("inlineStyle")&&(this.options.cluster.inlineStyle=""),this.options.hasOwnProperty("balloonParams")||(this.options.balloonParams={}),this.options.hasOwnProperty("balloonParams")&&"object"==_typeof(this.options.balloonParams)&&(this.options.balloonParams.hasOwnProperty("showHeader")||(this.options.balloonParams.showHeader=!0),this.options.balloonParams.hasOwnProperty("closeButton")||(this.options.balloonParams.closeButton="x")),this.options.hasOwnProperty("balloonBeforeBreakpoint")||(this.options.balloonBeforeBreakpoint=!1),this.options.hasOwnProperty("balloonAfterBreakpoint")||(this.options.balloonAfterBreakpoint=!1),this.options.hasOwnProperty("adaptiveBreakpoint")||(this.options.adaptiveBreakpoint=1024),this.options.hasOwnProperty("drag")||(this.options.drag={}),this.options.hasOwnProperty("drag")&&"object"==_typeof(this.options.drag)&&(this.options.drag.hasOwnProperty("disableMobile")||(this.options.drag.disableMobile=!0),this.options.drag.hasOwnProperty("disableDesktop")||(this.options.drag.disableDesktop=!1)),this.options.hasOwnProperty("placemark")||(this.options.placemark={}),this.options.hasOwnProperty("placemark")&&"object"==_typeof(this.options.placemark)&&!this.options.placemark.hasOwnProperty("icons")&&(this.options.placemark.icons=["islands#redDotIcon","islands#blueDotIcon"]),this.options.hasOwnProperty("placemark")&&"object"==_typeof(this.options.placemark)&&!this.options.placemark.hasOwnProperty("clicked")&&(this.options.placemark.clicked=!0))):console.log("You need to set mapContainer option"):console.log("You need to set mapCenter option"):console.log("You need to set container option"):console.log("You need to JSON data")}},{key:"_initMap",value:function(){var t=$("#"+this.options.mapContainer);if(this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null),!t.find(".ylist-tooltip").length){var s=$('<div class="ylist-tooltip">\n                    <span class="ylist-tooltip__text">Чтобы переместить карту, проведите по ней двумя пальцами</span>\n                </div>');t.append(s)}this.map=new ymaps.Map(this.options.mapContainer,{center:this.options.mapCenter,zoom:13,controls:[]});var o=new ymaps.control.ZoomControl({options:{size:"small",position:{top:10,right:10}}});if(this.map.controls.add(o),this.map.behaviors.disable("scrollZoom"),this._createPlacemarks(),"boolean"!=typeof this.options.cluster||this.options.cluster?(this._createClusterer(),this._addClusterer(),this._setBounds(this.clusterer)):(this._addPlacemarks(),this._setBounds(this.map.geoObjects)),this.isLessThanAdaptiveBreakpoint&&!0===this.options.drag.disableMobile){var i=$("#"+this.options.mapContainer),e=i.find(".ylist-tooltip");this.map.behaviors.disable("drag"),i.on("touchmove",function(t){1==t.originalEvent.touches.length?e.css("opacity","1"):e.css("opacity","0")}).on("touchstart",function(t){e.css("opacity","0")}).on("touchend",function(t){e.css("opacity","0")}).on("touchleave",function(t){e.css("opacity","0")}).on("touchcancel",function(t){e.css("opacity","0")})}this.isLessThanAdaptiveBreakpoint||!0!==this.options.drag.disableDesktop||this.map.behaviors.disable("drag"),this.needReloadMap=!1}},{key:"_destroyMap",value:function(){this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null)}},{key:"_initList",value:function(){this._createPointsList()}},{key:"_createPlacemarks",value:function(){for(var t=this,s=0;s<this.points.length;s++){var o=void 0;o=this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&this.options.placemark.clicked||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked?this._setBalloonData(s):{};var i=this.points[s],e=new ymaps.Placemark(i.coords,o,this._setPlacemarkOptions(s));e.id=i.id,e.events.add("click",function(s){t._placemarkClickHandler(s,t)}),this.activeListItem&&this.activeListItem==i.id&&("string"==typeof this.options.placemark.icons[0]?e.options.set("preset",this.options.placemark.icons[1]):e.options.set("iconImageHref",this.options.placemark.icons[1].href),e.isActive=!0),this.placemarks.push(e)}}},{key:"_addPlacemarks",value:function(){for(var t=0;t<this.placemarks.length;t++)this.map.geoObjects.add(this.placemarks[t])}},{key:"_setPlacemarkOptions",value:function(t){var s={};return"string"==typeof this.options.placemark.icons[0]?s.preset=this.options.placemark.icons[0]:(s.iconLayout="default#image",s.iconImageHref=this.options.placemark.icons[0].href,s.iconImageSize=this.options.placemark.icons[0].size,s.iconImageOffset=this.options.placemark.icons[0].offset),(this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&this.options.placemark.clicked||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked)&&(s.balloonLayout=this._createBalloonLayout(),s.balloonContentLayout=this._createBalloonContentLayout(),s.balloonAutoPan=!1,s.balloonShadow=!1,s.balloonPanelMaxMapArea=0),this.options.placemark.clicked||(s.cursor="default"),s}},{key:"_createClusterer",value:function(){if(this.clusterer&&this.clusterer.removeAll(),this.clusterer=new ymaps.Clusterer({groupByCoordinates:!1,clusterDisableClickZoom:!1,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,zoomMargin:40}),"string"==typeof this.options.cluster.icons[0])this.clusterer.options.set({preset:this.options.cluster.icons[0]});else{var t=ymaps.templateLayoutFactory.createClass('<div style="'+this.options.cluster.inlineStyle+'">{{ properties.geoObjects.length }}</div>');this.clusterer.options.set({clusterIcons:this.options.cluster.icons[0],clusterNumbers:[100],clusterIconContentLayout:t})}this.clusterer.add(this.placemarks)}},{key:"_addClusterer",value:function(){this.map.geoObjects.add(this.clusterer)}},{key:"_createBalloonLayout",value:function(){var t=this;return ymaps.templateLayoutFactory.createClass('<div class="ylist-balloon">\n                <button class="ylist-balloon__close" type="button">'+this.options.balloonParams.closeButton+'</button>\n                <div class="ylist-balloon__inner">\n                    $[[options.contentLayout]]\n                </div>\n            </div>',{build:function(){this.constructor.superclass.build.call(this),this._$element=$(".ylist-balloon",this.getParentElement()),this.applyElementOffset(),this._$element.find(".ylist-balloon__close").on("click",$.proxy(this.onCloseClick,this)),t.balloonParams.balloonWidth=this._$element[0].offsetWidth,t.balloonParams.balloonHeight=this._$element[0].offsetHeight+t.balloonParams.balloonTailHeight},clear:function(){this._$element.find(".ylist-balloon__close").off("click"),this.constructor.superclass.clear.call(this)},onSublayoutSizeChange:function(){this.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments),this._isElement(this._$element)&&(this.applyElementOffset(),this.events.fire("shapechange"))},applyElementOffset:function(){this._$element.css({left:-this._$element[0].offsetWidth/2,top:-(this._$element[0].offsetHeight+t.balloonParams.balloonTailHeight)})},onCloseClick:function(t){t.preventDefault(),this.events.fire("userclose")},_isElement:function(t){return t&&t[0]&&t.find(".ylist-balloon__inner")[0]}})}},{key:"_createBalloonContentLayout",value:function(){var t="";return t=!1===this.options.balloonParams.showHeader?'<div class="ylist-balloon__content">$[properties.balloonContent]</div>':'<h3 class="ylist-balloon__title">$[properties.balloonHeader]</h3>\n                                    <div class="ylist-balloon__content">$[properties.balloonContent]</div>',this.options.balloonParams.hasOwnProperty("setValue")&&"function"==typeof this.options.balloonParams.setValue&&(t=this.options.balloonParams.setValue(t)),ymaps.templateLayoutFactory.createClass(t)}},{key:"_setBalloonData",value:function(t){for(var s="",o=0;o<this.options.dataOrder.length;o++){var i=this.options.dataOrder[o];"object"===(void 0===i?"undefined":_typeof(i))&&null!==i?("function"!=typeof i.setValue&&console.error("Значение setValue должно быть функцией!"),s+='<p class="ylist-balloon__'+i.name+'">'+i.setValue(this.points[t][i.name])+"</p>"):s+='<p class="ylist-balloon__'+i+'">'+this.points[t][i]+"</p>"}return{balloonHeader:this.points[t].name,balloonContent:s}}},{key:"_createListElement",value:function(t){var s=$("<h3/>",{class:this.listClassName+"__title"}),o="",i=$("<li/>",{id:t.id,class:this.listClassName+"__item"});"string"==typeof t.name&&!1!==this.options.listParams.showHeader?s.html("<a>"+t.name+"</a>"):s=null;for(var e=0;e<this.options.dataOrder.length;e++){var a=this.options.dataOrder[e];"object"===(void 0===a?"undefined":_typeof(a))&&null!==a?("function"!=typeof a.setValue&&console.error("Значение setValue должно быть функцией!"),o+='<p class="'+this.listClassName+"__"+a.name+'">'+a.setValue(t[a.name])+"</p>"):o+='<p class="'+this.listClassName+"__"+a+'">'+t[a]+"</p>"}return this.options.listParams.hasOwnProperty("setValue")&&"function"==typeof this.options.listParams.setValue&&(o=this.options.listParams.setValue(o)),i.append(s,o),i}},{key:"_createPointsList",value:function(){for(var t=this,s=$("<ul/>",{class:this.listClassName}),o=0;o<this.points.length;o++){var i=this.points[o];s.append(this._createListElement(i))}$("#"+this.options.listContainer).html("").append(s),$(document).on("click","."+t.listClassName+"__title",function(s){var o=$(this).closest("."+t.listClassName+"__item").attr("id");if(t.placemarks.length>0)for(var i=0;i<t.placemarks.length;i++){var e=t.placemarks[i];if(e.id==o){t._listItemClickHandler(s,e);break}}else t._listItemClickHandler(s,o)})}},{key:"_setBounds",value:function(t){"object"===_typeof(this.placemarks)&&1===this.placemarks.length?this.map.setCenter(this.placemarks[0].geometry.getCoordinates(),16):this.map.setBounds(t.getBounds(),{checkZoomRange:!0,zoomMargin:10})}},{key:"_placemarkClickHandler",value:function(t,s){if(this.options.placemark.clicked){var o=t.get("target");if(s.activePlacemark=o,this._commonClickHandler(o),this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint){s.map.geoObjects.events.add("balloonopen",function t(){var i,e=void 0;(e=s.map.options.get("projection").toGlobalPixels(o.geometry.getCoordinates(),s.map.getZoom()))[1]-=s.balloonParams.balloonHeight/2,i=s.map.options.get("projection").fromGlobalPixels(e,s.map.getZoom()),s.map.panTo(i,{flying:!0}),s.map.geoObjects.events.remove("balloonopen",t)})}else s.map.panTo(o.geometry.getCoordinates(),{flying:!0})}}},{key:"_listItemClickHandler",value:function(t,s){if(this._commonClickHandler(s),"string"!=typeof s){if(this.activePlacemark&&this.map.getZoom()<11){var o=this.clusterer.getObjectState(this.activePlacemark).isClustered,i=this.clusterer.getObjectState(s).isClustered;if(!o&&!i)return this.map.panTo(s.geometry.getCoordinates(),{flying:!0}),void(this.activePlacemark=s)}for(var e=9===this.map.getZoom()?this.map.getZoom():9;this.map.setCenter(s.geometry.getCoordinates(),e++),this.clusterer.getObjectState(s).isClustered;);this.activePlacemark=s}}},{key:"_commonClickHandler",value:function(t){var s=null,o=null,i=null;if(this.options.list&&(s=$("#"+this.options.listContainer)),"string"==typeof t)this.options.list&&(o=$("#"+t)),i=t;else{this.options.list&&(o=$("#"+t.id)),i=t.id;for(var e=0;e<this.placemarks.length;e++){var a=this.placemarks[e];"string"==typeof this.options.placemark.icons[0]?a.options.set("preset",this.options.placemark.icons[0]):a.options.set("iconImageHref",this.options.placemark.icons[0].href),a.balloon.close(),this.clusterer.getObjectState(a).cluster&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(a).cluster.options.set("preset",this.options.cluster.icons[0]):this.clusterer.getObjectState(a).cluster.options.set("clusterIcons",this.options.cluster.icons[0])),a.isActive=!1}this.clusterer.getObjectState(t).isClustered&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(t).cluster.options.set("preset",this.options.cluster.icons[1]):this.clusterer.getObjectState(t).cluster.options.set("clusterIcons",this.options.cluster.icons[1])),"string"==typeof this.options.placemark.icons[0]?t.options.set("preset",this.options.placemark.icons[1]):t.options.set("iconImageHref",this.options.placemark.icons[1].href),t.isActive=!0}this.activeListItem=i,this.options.list&&(s.find(".is-active").removeClass("is-active"),o.addClass("is-active"),"boolean"!=typeof this.options.listScroll||this.options.listScroll?this.options.listScroll(s,o):s.scrollTop(o.position().top+s.scrollTop()))}},{key:"_adaptiveHandle",value:function(t,s){t.matches?(s.isLessThanAdaptiveBreakpoint=!0,s.needReloadMap=!0,s.options.list&&s._destroyMap(),0!=s.options.switchContainer&&($("#"+s.options.switchContainer).addClass("is-visible"),$("#"+s.options.switchContainer).find('[data-ylist-switch="list"]').addClass("is-active")),s.options.list&&$("#"+s.options.mapContainer).addClass("is-hidden"),$("#"+s.options.mapContainer).addClass("is-adaptive"),$("#"+s.options.listContainer).addClass("is-adaptive"),$("#"+s.options.container).addClass("is-adaptive"),s.options.list||s.map||s._initMap(),$(document).on("click","#"+s.options.switchContainer+" [data-ylist-switch]",function(t){s._switchHandler(t,s)})):(s.isLessThanAdaptiveBreakpoint=!1,0!=s.options.switchContainer&&($("#"+s.options.switchContainer).removeClass("is-visible"),$("#"+s.options.switchContainer).find("[data-ylist-switch]").removeClass("is-active")),$("#"+s.options.mapContainer).removeClass("is-adaptive is-hidden"),$("#"+s.options.listContainer).removeClass("is-adaptive is-hidden"),$("#"+s.options.container).removeClass("is-adaptive"),!s.options.list&&(s.options.list||s.isLessThanAdaptiveBreakpoint||s.map)||s._initMap(),$(document).off("click","#"+s.options.switchContainer+" [data-ylist-switch]",s._switchHandler))}},{key:"_switchHandler",value:function(t,s){var o=$(t.target);o.length&&!o.hasClass("is-active")&&("map"===o.attr("data-ylist-switch")?($("#"+s.options.mapContainer).removeClass("is-hidden"),$("#"+s.options.listContainer).addClass("is-hidden"),s.needReloadMap&&s._initMap()):"list"===o.attr("data-ylist-switch")&&($("#"+s.options.mapContainer).addClass("is-hidden"),$("#"+s.options.listContainer).removeClass("is-hidden")),$("#"+s.options.switchContainer).find("[data-ylist-switch]").removeClass("is-active"),o.addClass("is-active"))}}]),t}();