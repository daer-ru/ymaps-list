"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,s){for(var e=0;e<s.length;e++){var i=s[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(s,e,i){return e&&t(s.prototype,e),i&&t(s,i),s}}();function _classCallCheck(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}var Ylist=function(){function t(s){_classCallCheck(this,t),this.options=s,this.map=null,s.hasOwnProperty("data")?this.points=this.options.data:this.points=null,this.placemarks=[],this.activePlacemark=null,this.activeListItem=null,this.clusterer=null,this.balloonLayout=null,this.balloonParams={balloonWidth:null,balloonHeight:null,balloonTailHeight:15},this.listClassName="ylist-list",this.isLessThanAdaptiveBreakpoint=!1,this.mqlAdaptiveBreakpoint=window.matchMedia("(max-width: "+(this.options.adaptiveBreakpoint-1)+"px)"),this.needReloadMap=!0}return _createClass(t,[{key:"init",value:function(){this._checkRequiredOptions();var t=this;ymaps.ready(function(){t.mqlAdaptiveBreakpoint.addListener(function(){t._adaptiveHandle(this,t)}),t._adaptiveHandle(t.mqlAdaptiveBreakpoint,t)}),this.options.list.active&&this._initList()}},{key:"_checkRequiredOptions",value:function(){if(this.points)if(!this.options.hasOwnProperty("dataOrder")||this.options.hasOwnProperty("dataOrder")&&0==this.options.dataOrder.length)console.log("You need to set dataOrder option");else if(this.options.hasOwnProperty("dataExtension")||(this.options.dataExtension={}),this.options.hasOwnProperty("container")){if(this.options.hasOwnProperty("map")||(this.options.map={}),this.options.hasOwnProperty("map")&&"object"==_typeof(this.options.map)){if(!this.options.map.hasOwnProperty("center"))return void console.log("You need to set map.center option");if(!this.options.map.hasOwnProperty("container"))return void console.log("You need to set map.container option");this.options.map.hasOwnProperty("drag")||(this.options.map.drag={}),this.options.map.hasOwnProperty("drag")&&"object"==_typeof(this.options.map.drag)&&(this.options.map.drag.hasOwnProperty("disableBeforeBreakpoint")||(this.options.map.drag.disableBeforeBreakpoint=!0),this.options.map.drag.hasOwnProperty("disableAfterBreakpoint")||(this.options.map.drag.disableAfterBreakpoint=!0))}if(this.options.hasOwnProperty("list")||(this.options.list={}),this.options.hasOwnProperty("list")&&"object"==_typeof(this.options.list)){if(this.options.list.hasOwnProperty("active")||(this.options.list.active=!1),this.options.list.hasOwnProperty("active")&&this.options.list.active&&!this.options.list.hasOwnProperty("container"))return void console.log("You need to set container option in list");this.options.list.hasOwnProperty("scroll")||(this.options.list.scroll=!1),this.options.list.hasOwnProperty("header")||(this.options.list.header=!0)}this.options.hasOwnProperty("switchContainer")||(this.options.switchContainer=!1),this.options.hasOwnProperty("cluster")||(this.options.cluster={}),this.options.hasOwnProperty("cluster")&&"object"==_typeof(this.options.cluster)&&(this.options.cluster.hasOwnProperty("icons")||(this.options.cluster.icons=["islands#invertedRedClusterIcons","islands#invertedBlueClusterIcons"]),this.options.cluster.hasOwnProperty("inlineStyle")||(this.options.cluster.inlineStyle="")),this.options.hasOwnProperty("placemark")||(this.options.placemark={}),this.options.hasOwnProperty("placemark")&&"object"==_typeof(this.options.placemark)&&(this.options.placemark.hasOwnProperty("icons")||(this.options.placemark.icons=["islands#redDotIcon","islands#blueDotIcon"]),this.options.placemark.hasOwnProperty("clicked")||(this.options.placemark.clicked=!0)),this.options.hasOwnProperty("balloon")||(this.options.balloon={}),this.options.hasOwnProperty("balloon")&&"object"==_typeof(this.options.balloon)&&(this.options.balloon.hasOwnProperty("activeBeforeBreakpoint")||(this.options.balloon.activeBeforeBreakpoint=!1),this.options.balloon.hasOwnProperty("activeAfterBreakpoint")||(this.options.balloon.activeAfterBreakpoint=!1),this.options.balloon.hasOwnProperty("closeButton")||(this.options.balloon.closeButton="x"),this.options.balloon.hasOwnProperty("header")||(this.options.balloon.header=!0)),this.options.hasOwnProperty("adaptiveBreakpoint")||(this.options.adaptiveBreakpoint=1024)}else console.log("You need to set container option");else console.log("You need to JSON data")}},{key:"_initMap",value:function(){this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null),this.map=new ymaps.Map(this.options.map.container,{center:this.options.map.center,zoom:13,controls:[]});var t=new ymaps.control.ZoomControl({options:{size:"small",position:{top:10,right:10}}});this.map.controls.add(t),this.map.behaviors.disable("scrollZoom"),this._createPlacemarks(),"boolean"!=typeof this.options.cluster||this.options.cluster?(this._createClusterer(),this._addClusterer(),this._setBounds(this.clusterer)):(this._addPlacemarks(),this._setBounds(this.map.geoObjects)),(this.isLessThanAdaptiveBreakpoint&&this.options.map.drag.disableBeforeBreakpoint||!this.isLessThanAdaptiveBreakpoint&&this.options.map.drag.disableAfterBreakpoint)&&this.map.behaviors.disable("drag"),this.needReloadMap=!1}},{key:"_destroyMap",value:function(){this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null)}},{key:"_initList",value:function(){this._createPointsList()}},{key:"_createPlacemarks",value:function(){for(var t=this,s=0;s<this.points.length;s++){var e=void 0,i=this.options.balloon.activeBeforeBreakpoint,o=this.options.balloon.activeAfterBreakpoint;e=i&&o&&this.options.placemark.clicked||i&&!o&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!i&&o&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked?this._setBalloonData(s):{};var a=this.points[s],n=new ymaps.Placemark(a.coords,e,this._setPlacemarkOptions(s));n.id=a.id,n.events.add("click",function(s){t._placemarkClickHandler(s,t)}),this.activeListItem&&this.activeListItem==a.id&&("string"==typeof this.options.placemark.icons[0]?n.options.set("preset",this.options.placemark.icons[1]):n.options.set("iconImageHref",this.options.placemark.icons[1].href),n.isActive=!0),this.placemarks.push(n)}}},{key:"_addPlacemarks",value:function(){for(var t=0;t<this.placemarks.length;t++)this.map.geoObjects.add(this.placemarks[t])}},{key:"_setPlacemarkOptions",value:function(t){var s={},e=this.options.balloon.activeBeforeBreakpoint,i=this.options.balloon.activeAfterBreakpoint;return"string"==typeof this.options.placemark.icons[0]?s.preset=this.options.placemark.icons[0]:(s.iconLayout="default#image",s.iconImageHref=this.options.placemark.icons[0].href,s.iconImageSize=this.options.placemark.icons[0].size,s.iconImageOffset=this.options.placemark.icons[0].offset),(e&&i&&this.options.placemark.clicked||e&&!i&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!e&&i&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked)&&(s.balloonLayout=this._createBalloonLayout(),s.balloonContentLayout=this._createBalloonContentLayout(),s.balloonAutoPan=!1,s.balloonShadow=!1,s.balloonPanelMaxMapArea=0),this.options.placemark.clicked||(s.cursor="default"),s}},{key:"_createClusterer",value:function(){if(this.clusterer&&this.clusterer.removeAll(),this.clusterer=new ymaps.Clusterer({groupByCoordinates:!1,clusterDisableClickZoom:!1,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,zoomMargin:40}),"string"==typeof this.options.cluster.icons[0])this.clusterer.options.set({preset:this.options.cluster.icons[0]});else{var t=ymaps.templateLayoutFactory.createClass('<div style="'+this.options.cluster.inlineStyle+'">{{ properties.geoObjects.length }}</div>');this.clusterer.options.set({clusterIcons:this.options.cluster.icons[0],clusterNumbers:[100],clusterIconContentLayout:t})}this.clusterer.add(this.placemarks)}},{key:"_addClusterer",value:function(){this.map.geoObjects.add(this.clusterer)}},{key:"_createBalloonLayout",value:function(){var t=this;return ymaps.templateLayoutFactory.createClass('<div class="ylist-balloon">\n                <button class="ylist-balloon__close" type="button">'+this.options.balloon.closeButton+'</button>\n                <div class="ylist-balloon__inner">\n                    $[[options.contentLayout]]\n                </div>\n            </div>',{build:function(){this.constructor.superclass.build.call(this),this._$element=$(".ylist-balloon",this.getParentElement()),this.applyElementOffset(),this._$element.find(".ylist-balloon__close").on("click",$.proxy(this.onCloseClick,this)),t.balloonParams.balloonWidth=this._$element[0].offsetWidth,t.balloonParams.balloonHeight=this._$element[0].offsetHeight+t.balloonParams.balloonTailHeight},clear:function(){this._$element.find(".ylist-balloon__close").off("click"),this.constructor.superclass.clear.call(this)},onSublayoutSizeChange:function(){this.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments),this._isElement(this._$element)&&(this.applyElementOffset(),this.events.fire("shapechange"))},applyElementOffset:function(){this._$element.css({left:-this._$element[0].offsetWidth/2,top:-(this._$element[0].offsetHeight+t.balloonParams.balloonTailHeight)})},onCloseClick:function(t){t.preventDefault(),this.events.fire("userclose")},_isElement:function(t){return t&&t[0]&&t.find(".ylist-balloon__inner")[0]}})}},{key:"_createBalloonContentLayout",value:function(){var t="";return t=!1===this.options.balloon.header?'<div class="ylist-balloon__content">$[properties.balloonContent]</div>':'<h3 class="ylist-balloon__title">$[properties.balloonHeader]</h3>\n                                    <div class="ylist-balloon__content">$[properties.balloonContent]</div>',ymaps.templateLayoutFactory.createClass(t)}},{key:"_setBalloonData",value:function(t){for(var s="",e="",i=0;i<this.options.dataOrder.length;i++){var o=this.options.dataOrder[i],a="",n="";this.options.dataExtension.hasOwnProperty(o)&&"name"!=o?n=this.options.dataExtension[o](this.points[t][o]):this.options.dataExtension.hasOwnProperty(o)&&"name"==o?a=this.options.dataExtension[o](this.points[t][o]):(a=this.points[t].name,n=this.points[t][o]),s+=a,e+=n}return{balloonHeader:s,balloonContent:e}}},{key:"_createListElement",value:function(t){var s=$("<h3/>",{class:this.listClassName+"__title"}),e="",i=$("<li/>",{id:t.id,class:this.listClassName+"__item"});t.name&&this.options.list.header?this.options.dataExtension.hasOwnProperty("name")?s.html(this.options.dataExtension.name(t.name)):s.html(t.name):s=null;for(var o=0;o<this.options.dataOrder.length;o++){var a=this.options.dataOrder[o],n="";this.options.dataExtension.hasOwnProperty(a)&&"name"!=a?n=this.options.dataExtension[a](t[a]):"name"!=a&&(n=t[a]),e+=n}return i.append(s,e),i}},{key:"_createPointsList",value:function(){for(var t=this,s=$("<ul/>",{class:this.listClassName}),e=0;e<this.points.length;e++){var i=this.points[e];s.append(this._createListElement(i))}$("#"+this.options.list.container).html("").append(s),$(document).on("click","."+t.listClassName+"__title",function(s){var e=$(this).closest("."+t.listClassName+"__item").attr("id");if(t.placemarks.length>0)for(var i=0;i<t.placemarks.length;i++){var o=t.placemarks[i];if(o.id==e){t._listItemClickHandler(s,o);break}}else t._listItemClickHandler(s,e)})}},{key:"_setBounds",value:function(t){"object"===_typeof(this.placemarks)&&1===this.placemarks.length?this.map.setCenter(this.placemarks[0].geometry.getCoordinates(),16):this.map.setBounds(t.getBounds(),{checkZoomRange:!0,zoomMargin:10})}},{key:"_placemarkClickHandler",value:function(t,s){if(this.options.placemark.clicked){var e=t.get("target"),i=this.options.balloon.activeBeforeBreakpoint,o=this.options.balloon.activeAfterBreakpoint;if(s.activePlacemark=e,this._commonClickHandler(e),i&&o||i&&!o&&this.isLessThanAdaptiveBreakpoint||!i&&o&&!this.isLessThanAdaptiveBreakpoint){s.map.geoObjects.events.add("balloonopen",function t(){var i,o=void 0;(o=s.map.options.get("projection").toGlobalPixels(e.geometry.getCoordinates(),s.map.getZoom()))[1]-=s.balloonParams.balloonHeight/2,i=s.map.options.get("projection").fromGlobalPixels(o,s.map.getZoom()),s.map.panTo(i,{flying:!0}),s.map.geoObjects.events.remove("balloonopen",t)})}else s.map.panTo(e.geometry.getCoordinates(),{flying:!0})}}},{key:"_listItemClickHandler",value:function(t,s){if(this._commonClickHandler(s),"string"!=typeof s){if(this.activePlacemark&&this.map.getZoom()<11){var e=this.clusterer.getObjectState(this.activePlacemark).isClustered,i=this.clusterer.getObjectState(s).isClustered;if(!e&&!i)return this.map.panTo(s.geometry.getCoordinates(),{flying:!0}),void(this.activePlacemark=s)}for(var o=9===this.map.getZoom()?this.map.getZoom():9;this.map.setCenter(s.geometry.getCoordinates(),o++),this.clusterer.getObjectState(s).isClustered;);this.activePlacemark=s}}},{key:"_commonClickHandler",value:function(t){var s=null,e=null,i=null,o=this.options.list.active;if(o&&(s=$("#"+this.options.list.container)),"string"==typeof t)o&&(e=$("#"+t)),i=t;else{o&&(e=$("#"+t.id)),i=t.id;for(var a=0;a<this.placemarks.length;a++){var n=this.placemarks[a];"string"==typeof this.options.placemark.icons[0]?n.options.set("preset",this.options.placemark.icons[0]):n.options.set("iconImageHref",this.options.placemark.icons[0].href),n.balloon.close(),this.clusterer.getObjectState(n).cluster&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(n).cluster.options.set("preset",this.options.cluster.icons[0]):this.clusterer.getObjectState(n).cluster.options.set("clusterIcons",this.options.cluster.icons[0])),n.isActive=!1}this.clusterer.getObjectState(t).isClustered&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(t).cluster.options.set("preset",this.options.cluster.icons[1]):this.clusterer.getObjectState(t).cluster.options.set("clusterIcons",this.options.cluster.icons[1])),"string"==typeof this.options.placemark.icons[0]?t.options.set("preset",this.options.placemark.icons[1]):t.options.set("iconImageHref",this.options.placemark.icons[1].href),t.isActive=!0}this.activeListItem=i,o&&(s.find(".is-active").removeClass("is-active"),e.addClass("is-active"),"boolean"!=typeof this.options.list.scroll||this.options.list.scroll?this.options.list.scroll(s,e):s.scrollTop(e.position().top+s.scrollTop()))}},{key:"_adaptiveHandle",value:function(t,s){var e=s.options.list.active;t.matches?(s.isLessThanAdaptiveBreakpoint=!0,s.needReloadMap=!0,e&&s._destroyMap(),0!=s.options.switchContainer&&($("#"+s.options.switchContainer).addClass("is-visible"),$("#"+s.options.switchContainer).find('[data-ylist-switch="list"]').addClass("is-active")),e&&$("#"+s.options.map.container).addClass("is-hidden"),$("#"+s.options.map.container).addClass("is-adaptive"),$("#"+s.options.list.container).addClass("is-adaptive"),$("#"+s.options.container).addClass("is-adaptive"),e||s.map||s._initMap(),$(document).on("click","[data-ylist-switch]",function(t){s._switchHandler(t,s)})):(s.isLessThanAdaptiveBreakpoint=!1,0!=s.options.switchContainer&&($("#"+s.options.switchContainer).removeClass("is-visible"),$("#"+s.options.switchContainer).find("[data-ylist-switch]").removeClass("is-active")),$("#"+s.options.map.container).removeClass("is-adaptive is-hidden"),$("#"+s.options.list.container).removeClass("is-adaptive is-hidden"),$("#"+s.options.container).removeClass("is-adaptive"),!e&&(e||s.isLessThanAdaptiveBreakpoint||s.map)||s._initMap(),$(document).off("click","[data-ylist-switch]",s._switchHandler))}},{key:"_switchHandler",value:function(t,s){var e=$(t.target);e.length&&!e.hasClass("is-active")&&("map"===e.attr("data-ylist-switch")?($("#"+s.options.map.container).removeClass("is-hidden"),$("#"+s.options.list.container).addClass("is-hidden"),s.needReloadMap&&s._initMap()):"list"===e.attr("data-ylist-switch")&&($("#"+s.options.map.container).addClass("is-hidden"),$("#"+s.options.list.container).removeClass("is-hidden")),$("[data-ylist-switch]").removeClass("is-active"),e.addClass("is-active"))}}]),t}();